<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mill Sandboxing :: The Mill Build Tool</title>
    <link rel="prev" href="The_Mill_Evaluation_Model.html" />
    <link rel="next" href="Import_File_And_Import_Ivy.html" />
    <meta name="generator" content="Antora 3.1.9" />
    <link rel="stylesheet" href="../_/css/site.css" />
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-1C582ZJR85"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-1C582ZJR85')</script>
<link rel="icon" href="../_/favicon.png" type="image/x-icon" />
  
  </head><body class="article">
  
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <!-- TODO: add mill icon -->
      <a class="navbar-item" href="https://mill-build.org"><img src="../_/logo-white.svg" height="20" />Â The Mill Build Tool</a>
      <div class="navbar-item search">
        <input id="search-input" type="text" placeholder="Search the docs" />
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill">Source Code (GitHub)</a>
        <a class="navbar-item" href="https://mill-build.org/api/latest/index.html">API</a>
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill/issues">Issues</a>
        <a class="navbar-item" href="https://github.com/com-lihaoyi/mill/discussions">Discuss</a>
        <a class="navbar-item" href="https://discord.com/channels/632150470000902164/940067748103487558">Chat</a>

            <!--
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#"></a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Plugins</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
        -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mill" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">

  <li class="nav-item is-active" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="Java_Intro_to_Mill.html">Introduction to Mill for Java</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Java_Installation_IDE_Support.html">Installation and IDE Support</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Java_Builtin_Commands.html">Built-in Commands</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Java_Module_Config.html">Java Module Configuration</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Java_Build_Examples.html">Java Build Examples</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Testing_Java_Projects.html">Testing Java Projects</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Linting_Java_Projects.html">Linting Java Projects</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Java_Web_Examples.html">Java Web Examples</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Case_Study_Mill_vs_Maven.html">Case Study: Mill vs Maven</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Case_Study_Mill_vs_Gradle.html">Case Study: Mill vs Gradle</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="Scala_Intro_to_Mill.html">Introduction to Mill for Scala</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Scala_Installation_IDE_Support.html">Installation and IDE Support</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Scala_Builtin_Commands.html">Built-in Commands</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Scala_Module_Config.html">Scala Module Configuration</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Scala_Build_Examples.html">Scala Build Examples</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Testing_Scala_Projects.html">Testing Scala Projects</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Scala_Web_Examples.html">Scala Web Examples</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Case_Study_Mill_vs_SBT.html">Case Study: Mill vs SBT</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Mill In Depth</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Library_Dependencies.html">Library Dependencies in Mill</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Out_Dir.html">The Output Directory</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Tasks.html">Tasks</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Modules.html">Modules</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Cross_Builds.html">Cross Builds</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Target_Query_Syntax.html">Target Query Syntax</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Structuring_Large_Builds.html">Structuring Large Builds</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="The_Mill_Evaluation_Model.html">The Mill Evaluation Model</a>
  </li>

  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="Mill_Sandboxing.html">Mill Sandboxing</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Extending Mill</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Import_File_And_Import_Ivy.html">import $file and import $ivy</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Using_Plugins.html">Using Plugins</a>
  </li>

  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="Contrib_Plugins.html">Contrib Plugins</a>
<ul class="nav-list">

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/artifactory.html">Artifactory</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/bintray.html">Bintray</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/bloop.html">Bloop</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/buildinfo.html">BuildInfo</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/codeartifact.html">Codeartifact</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/docker.html">Docker</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/errorprone.html">Mill ErrorProne Plugin</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/checkstyle.html">Checkstyle</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/flyway.html">Flyway</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/gitlab.html">Gitlab</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/jmh.html">JMH</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/playlib.html">Play Framework</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/proguard.html">Proguard</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/scalapblib.html">ScalaPB</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/scoverage.html">Scoverage</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/sonatypecentral.html">Sonatype Central</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/testng.html">TestNG</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/twirllib.html">Twirl</a>
  </li>

  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="contrib/versionfile.html">Version file</a>
  </li>
</ul>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Thirdparty_Plugins.html">Third-Party Plugins</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Writing_Mill_Plugins.html">Writing Mill Plugins</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="The_Mill_Meta_Build.html">The Mill Meta-Build</a>
  </li>
</ul>
  </li>

  <li class="nav-item is-active" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Mill_Design_Principles.html">Mill Design Principles</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Bundled_Libraries.html">Bundled Libraries</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://mill-build.org/api/latest/mill/index.html">Mill Scaladoc</a>
  </li>

  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Changelog.html">Changelog</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Mill Documentation</span>
    <span class="version">0.12.0-RC1-26-b5e556</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="0.11.12/index.html">Mill Documentation</a></div>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">0.12.0-RC1-26-b5e556</a>
        </li>
        <li class="version is-latest">
          <a href="0.11.12/index.html">0.11.12</a>
        </li>
        <li class="version">
          <a href="0.11.11/index.html">0.11.11</a>
        </li>
        <li class="version">
          <a href="0.11.10/index.html">0.11.10</a>
        </li>
        <li class="version">
          <a href="0.11.0-M7/index.html">0.11.0-M7</a>
        </li>
        <li class="version">
          <a href="0.10.15/index.html">0.10.15</a>
        </li>
        <li class="version">
          <a href="0.10.12/index.html">0.10.12</a>
        </li>
        <li class="version">
          <a href="0.10.0/index.html">0.10.0</a>
        </li>
        <li class="version">
          <a href="0.9.12/index.html">0.9.12</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="0.11.12/Java_Intro_to_Mill.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Mill Documentation</a></li>
    <li>Mill In Depth</li>
    <li><a href="Mill_Sandboxing.html">Mill Sandboxing</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">0.12.0-RC1-26-b5e556</button>
  <div class="version-menu">
    <a class="version is-current" href="Mill_Sandboxing.html">0.12.0-RC1-26-b5e556</a>
    <a class="version is-missing" href="0.11.12/index.html">0.11.12</a>
    <a class="version is-missing" href="0.11.11/index.html">0.11.11</a>
    <a class="version is-missing" href="0.11.10/index.html">0.11.10</a>
    <a class="version is-missing" href="0.11.0-M7/index.html">0.11.0-M7</a>
    <a class="version is-missing" href="0.10.15/index.html">0.10.15</a>
    <a class="version is-missing" href="0.10.12/index.html">0.10.12</a>
    <a class="version is-missing" href="0.10.0/index.html">0.10.0</a>
    <a class="version is-missing" href="0.9.12/index.html">0.9.12</a>
  </div>
</div>
<div class="edit-this-page"><a href="https://github.com/com-lihaoyi/mill/edit/main/docs/modules/ROOT/pages/Mill_Sandboxing.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Mill Sandboxing</h1>
<div class="sect1">
<h2 id="_task_sandboxing"><a class="anchor" href="#_task_sandboxing"></a>Task Sandboxing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to help manage your build, Mill performs some rudimentary filesystem
sandboxing to keep different tasks and modules from interfering with each other.
This tries to ensure your tasks only read and write from their designated <code>.dest/</code>
folders, which are unique to each task and thus guaranteed not to collide with
the filesystem operations of other tasks that may be occurring in parallel.</p>
</div>
<div class="sect2">
<h3 id="_t_dest"><a class="anchor" href="#_t_dest"></a><code>T.dest</code></h3>
<div class="paragraph">
<p>The standard way of working with a taskâs <code>.dest/</code> folder is through the <code>T.dest</code>
property. This is available within any task, and gives you access to the
<code>out/&lt;module-names&gt;/&lt;task-name&gt;.dest/</code> folder to use. The <code>.dest/</code> folder for
each task is lazily initialized when <code>T.dest</code> is referenced and used:</p>
</div>
<div class="listingblock">
<div class="title">build.mill (<a href="https://github.com/com-lihaoyi/mill/releases/download/0.12.0-RC1/0.12.0-RC1-example-depth-sandbox-1-task.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/0.12.0-RC1//example/depth/sandbox/1-task">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package build
import mill._

object foo extends Module{
  def tDestTask = T { println(T.dest.toString) }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill foo.tDestTask
.../out/foo/tDestTask.dest</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_task_os_pwd_redirection"><a class="anchor" href="#_task_os_pwd_redirection"></a>Task <code>os.pwd</code> redirection</h3>
<div class="paragraph">
<p>Mill also redirects the <code>os.pwd</code> property from <a href="https://github.com/com-lihaoyi/os-lib">OS-Lib</a>,
such that that also points towards a running taskâs own <code>.dest/</code> folder</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def osPwdTask = T { println(os.pwd.toString) }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill osPwdTask
.../out/osPwdTask.dest</code></pre>
</div>
</div>
<div class="paragraph">
<p>The redirection of <code>os.pwd</code> applies to <code>os.proc</code>, <code>os.call</code>, and <code>os.spawn</code> methods
as well. In the example below, we can see the <code>python3</code> subprocess we spawn prints
its <code>os.getcwd()</code>, which is our <code>osProcTask.dest/</code> sandbox folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">def osProcTask = T {
  println(os.call((&quot;python3&quot;, &quot;-c&quot;, &quot;import os; print(os.getcwd())&quot;), cwd = T.dest).out.trim())
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill osProcTask
.../out/osProcTask.dest</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_non_task_os_pwd_redirection"><a class="anchor" href="#_non_task_os_pwd_redirection"></a>Non-task <code>os.pwd</code> redirection</h3>
<div class="paragraph">
<p>Lastly, there is the possibily of calling <code>os.pwd</code> outside of a task. When outside of
a task there is no <code>.dest/</code> folder associated, so instead Mill will redirect <code>os.pwd</code>
towards an empty <code>sandbox/</code> folder in <code>out/mill-workerâ¦â/</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">val externalPwd = os.pwd
def externalPwdTask = T { println(externalPwd.toString) }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill externalPwdTask
.../out/mill-worker-.../sandbox/sandbox</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_limitations_of_mills_sandboxing"><a class="anchor" href="#_limitations_of_mills_sandboxing"></a>Limitations of Millâs Sandboxing</h3>
<div class="paragraph">
<p>Millâs approach to filesystem sandboxing is designed to avoid accidental interference
between different Mill tasks. It is not designed to block intentional misbehavior, and
tasks are always able to traverse the filesystem and do whatever they want. Furthermore,
Millâs redirection of <code>os.pwd</code> does not apply to <code>java.io</code> or <code>java.nio</code> APIs, which are
outside of Millâs control.</p>
</div>
<div class="paragraph">
<p>However, by setting <code>os.pwd</code> to safe sandbox folders, we hope to minimize the cases where
someone accidentally causes issues with their build by doing the wrong thing.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_sandboxing"><a class="anchor" href="#_test_sandboxing"></a>Test Sandboxing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mill also creates sandbox folders for test suites to run in. Consider the
following build with two modules <code>foo</code> and <code>bar</code>, and their test suites
<code>foo.test</code> and <code>bar.test</code>:</p>
</div>
<div class="listingblock">
<div class="title">build.mill (<a href="https://github.com/com-lihaoyi/mill/releases/download/0.12.0-RC1/0.12.0-RC1-example-depth-sandbox-2-test.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/0.12.0-RC1//example/depth/sandbox/2-test">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package build
import mill._, javalib._

trait MyModule extends JavaModule{
  object test extends JavaTests with TestModule.Junit4
}

object foo extends MyModule{
  def moduleDeps = Seq(bar)
}

object bar extends MyModule</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the sake of the example, both test modules contain tests that exercise the
logic in their corresponding non-test module, but also do some basic filesystem
operations at the same time, writing out a <code>generated.html</code> file and then reading it:</p>
</div>
<div class="listingblock">
<div class="title">foo/src/foo/Foo.java (<a href="https://github.com/com-lihaoyi/mill/blob/0.12.0-RC1//example/depth/sandbox/2-test/foo/src/foo/Foo.java">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package foo;

public class Foo {
    public static String generateHtml(String text) {
        return &quot;&lt;h1&gt;&quot; + text + &quot;&lt;/h1&gt;&quot;;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">foo/test/src/foo/FooTests.java (<a href="https://github.com/com-lihaoyi/mill/blob/0.12.0-RC1//example/depth/sandbox/2-test/foo/test/src/foo/FooTests.java">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package foo;

import static org.junit.Assert.assertEquals;
import org.junit.Test;
import java.nio.file.*;

public class FooTests {
    @Test
    public void simple() throws Exception {
        String result = Foo.generateHtml(&quot;hello&quot;);
        Path path = Paths.get(&quot;generated.html&quot;);
        Files.write(path, result.getBytes());
        assertEquals(&quot;&lt;h1&gt;hello&lt;/h1&gt;&quot;, Files.readString(path));
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">bar/src/bar/Bar.java (<a href="https://github.com/com-lihaoyi/mill/blob/0.12.0-RC1//example/depth/sandbox/2-test/bar/src/bar/Bar.java">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package bar;

public class Bar {
    public static String generateHtml(String text) {
        return &quot;&lt;p&gt;&quot; + text + &quot;&lt;/p&gt;&quot;;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">bar/test/src/bar/BarTests.java (<a href="https://github.com/com-lihaoyi/mill/blob/0.12.0-RC1//example/depth/sandbox/2-test/bar/test/src/bar/BarTests.java">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package bar;

import static org.junit.Assert.assertEquals;
import org.junit.Test;
import java.nio.file.*;

public class BarTests {
    @Test
    public void simple() throws Exception {
        String result = Bar.generateHtml(&quot;world&quot;);
        Path path = Paths.get(&quot;generated.html&quot;);
        Files.write(path, result.getBytes());
        assertEquals(&quot;&lt;p&gt;world&lt;/p&gt;&quot;, Files.readString(path));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both test suites can be run via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill __.test</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without sandboxing, due to the tests running in parallel, there is a race condition:
itâs possible that <code>FooTests</code> may write the file, <code>BarTests</code> write over it, before
<code>FooTests</code> reads the output from <code>BarTests</code>. That would cause non-deterministic
flaky failures in your test suite that can be very difficult to debug and resolve.</p>
</div>
<div class="paragraph">
<p>With Millâs test sandboxing, each test runs in a separate folder: the <code>.dest</code> folder
of the respective task and module. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>foo.test</code> runs in <code>out/foo/test/test.dest/</code></p>
</li>
<li>
<p><code>bar.test</code> runs in <code>out/bar/test/test.dest/</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a result, each testâs <code>generated.html</code> file is written to its own dedicated
working directory, without colliding with each other on disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; find . | grep generated.html
.../out/foo/test/test.dest/sandbox/generated.html
.../out/bar/test/test.dest/sandbox/generated.html

&gt; cat out/foo/test/test.dest/sandbox/generated.html
&lt;h1&gt;hello&lt;/h1&gt;

&gt; cat out/bar/test/test.dest/sandbox/generated.html
&lt;p&gt;world&lt;/p&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As each test suite runs in a different working directory by default, naive usage
reading and writing to the filesystem does not cause tests to interefere with
one another, which helps keep tests stable and deterministic even when run in
parallel</p>
</div>
<div class="paragraph">
<p>Like Millâs Task sandboxing, Millâs Test sandboxing does not guard against
intentional misbehavior: tests can still walk the filesystem from the
sandbox folder via <code>..</code> or from the root folder <code>/</code> or home folder <code>~/</code>.
Nevertheless, it should add some simple guardrails to prevent many common
causes of inter-test interference, letting your test suite run in parallel both
quickly and reliably</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_breaking_out_of_sandbox_folders"><a class="anchor" href="#_breaking_out_of_sandbox_folders"></a>Breaking Out Of Sandbox Folders</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Millâs sandboxing approach is best effort: while it tries to guide you into using
isolated sandbox folders, Mill cannot guarantee it, and in fact provides the
<code>T.workspace</code> property and <code>MILL_WORKSPACE_ROOT</code> environment variable to reference the
project root folder for scenarios where you may need it. This can be useful for a variety
of reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Migrating legacy applications that assume access to the workspace root</p>
</li>
<li>
<p>Scenarios where writing the the original source repository is necessary:
code auto-formatters, auto-fixers, auto-updaters. etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>T.workspace</code> can be used in tasks:</p>
</div>
<div class="listingblock">
<div class="title">build.mill (<a href="https://github.com/com-lihaoyi/mill/releases/download/0.12.0-RC1/0.12.0-RC1-example-depth-sandbox-3-breaking.zip">download</a>, <a href="https://github.com/com-lihaoyi/mill/blob/0.12.0-RC1//example/depth/sandbox/3-breaking">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package build
import mill._, javalib._

def tWorkspaceTask = T { println(T.workspace) }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill tWorkspaceTask</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whereas <code>MILL_WORKSPACE_ROOT</code> as well as in tests, which can access the
workspace root via the <code>MILL_WORKSPACE_ROOT</code> environment variable</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">object foo extends JavaModule{
  object test extends JavaTests with TestModule.Junit4
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">foo/src/foo/Foo.java (<a href="https://github.com/com-lihaoyi/mill/blob/0.12.0-RC1//example/depth/sandbox/3-breaking/foo/src/foo/Foo.java">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package foo;

public class Foo {
    public static String generateHtml(String text) {
        return &quot;&lt;h1&gt;&quot; + text + &quot;&lt;/h1&gt;&quot;;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">foo/test/src/foo/FooTests.java (<a href="https://github.com/com-lihaoyi/mill/blob/0.12.0-RC1//example/depth/sandbox/3-breaking/foo/test/src/foo/FooTests.java">browse</a>)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-scala hljs" data-lang="scala">package foo;

import java.util.stream.Collectors;
import java.nio.file.*;
import static org.junit.Assert.assertEquals;
import org.junit.Test;

public class FooTests {
    @Test
    public void simple() throws Exception {
        String workspaceRoot = System.getenv(&quot;MILL_WORKSPACE_ROOT&quot;);

        for(Path subpath: Files.list(Paths.get(workspaceRoot)).collect(Collectors.toList())){
            String result = Foo.generateHtml(subpath.getFileName().toString());
            Path tmppath = Paths.get(subpath.getFileName() + &quot;.html&quot;);
            Files.write(tmppath, result.getBytes());
            assertEquals(
                &quot;&lt;h1&gt;&quot; + subpath.getFileName() + &quot;&lt;/h1&gt;&quot;,
                Files.readString(tmppath)
            );
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; ./mill __.test</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; find . | grep .html
...
.../out/foo/test/test.dest/sandbox/foo.html

&gt; cat out/foo/test/test.dest/sandbox/foo.html
&lt;h1&gt;foo&lt;/h1&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_limitations"><a class="anchor" href="#_limitations"></a>Limitations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Millâs approach to filesystem sandboxing is designed to avoid accidental interference
between different Mill tasks. It is not designed to block intentional misbehavior, and
tasks are always able to traverse the filesystem and do whatever they want. Furthermore,
Millâs redirection of <code>os.pwd</code> does not apply to <code>java.io</code> or <code>java.nio</code> APIs, which are
outside of Millâs control.</p>
</div>
<div class="paragraph">
<p>However, by setting <code>os.pwd</code> to safe sandbox folders, we hope to minimize the cases where
someone accidentally causes issues with their build by doing the wrong thing.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="The_Mill_Evaluation_Model.html">The Mill Evaluation Model</a></span>
  <span class="next"><a href="Import_File_And_Import_Ivy.html">import $file and import $ivy</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async="async" src="../_/js/vendor/highlight.js"></script>
<script src="../_/js/vendor/lunr.js"></script>
<script src="../_/js/search-ui.js" id="search-ui-script" data-site-root-path=".." data-snippet-length="100" data-stylesheet="../_/css/search.css"></script>
<script async="async" src="../search-index.js"></script>
  
</body></html>